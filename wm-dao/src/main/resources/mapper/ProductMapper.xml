<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="site.wmblog.mapper.ProductMapper">
	<resultMap id="BaseResultMap" type="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		<id column="id" jdbcType="BIGINT" property="id" />
		<result column="supplier_id" jdbcType="BIGINT" property="supplierId" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="num" jdbcType="VARCHAR" property="num" />
		<result column="view_count" jdbcType="BIGINT" property="viewCount" />
		<result column="market_price" jdbcType="DOUBLE" property="marketPrice" />
		<result column="member_price" jdbcType="DOUBLE" property="memberPrice" />
		<result column="brand_id" jdbcType="BIGINT" property="brandId" />
		<result column="category_id" jdbcType="BIGINT" property="categoryId" />
		<result column="keyword" jdbcType="VARCHAR" property="keyword" />
		<result column="title" jdbcType="VARCHAR" property="title" />
		<result column="main_image_url" jdbcType="VARCHAR" property="mainImageUrl" />
		<result column="image_url_list" jdbcType="VARCHAR" property="imageUrlList" />
		<result column="state" jdbcType="VARCHAR" property="state" />
		<result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
	</resultMap>
	<resultMap extends="BaseResultMap" id="ResultMapWithBLOBs"
		type="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		<result column="description" jdbcType="LONGVARCHAR" property="description" />
	</resultMap>

	<resultMap type="com.yellowstone.dto.product.ProductDto" id="ProductDtoMap">
		<id column="id" jdbcType="BIGINT" property="id" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="num" jdbcType="VARCHAR" property="num" />
		<result column="market_price" jdbcType="DOUBLE" property="marketPrice" />
		<result column="state" jdbcType="VARCHAR" property="state" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
	</resultMap>

	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		id, supplier_id, name, num, view_count, market_price, member_price,
		brand_id, category_id,
		keyword, title, main_image_url, image_url_list,
		state, update_time,
		create_time
	</sql>
	<sql id="Blob_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		description
	</sql>
	<select id="selectByPrimaryKey" parameterType="java.lang.Long"
		resultMap="ResultMapWithBLOBs">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		select
		<include refid="Base_Column_List" />
		,
		<include refid="Blob_Column_List" />
		from t_product
		where id = #{id,jdbcType=BIGINT}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		delete from t_product
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" parameterType="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		insert into t_product (id, supplier_id, name,
		num, view_count,
		market_price,
		member_price, brand_id, category_id,
		keyword, title,
		main_image_url,
		image_url_list, state, update_time,
		create_time,
		description)
		values (#{id,jdbcType=BIGINT},
		#{supplierId,jdbcType=BIGINT},
		#{name,jdbcType=VARCHAR},
		#{num,jdbcType=VARCHAR}, #{viewCount,jdbcType=BIGINT},
		#{marketPrice,jdbcType=DOUBLE},
		#{memberPrice,jdbcType=DOUBLE},
		#{brandId,jdbcType=BIGINT},
		#{categoryId,jdbcType=BIGINT},
		#{keyword,jdbcType=VARCHAR}, #{title,jdbcType=VARCHAR},
		#{mainImageUrl,jdbcType=VARCHAR},
		#{imageUrlList,jdbcType=VARCHAR},
		#{state,jdbcType=VARCHAR},
		#{updateTime,jdbcType=TIMESTAMP},
		#{createTime,jdbcType=TIMESTAMP}, #{description,jdbcType=LONGVARCHAR})
	</insert>
	<insert id="insertSelective" parameterType="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Long">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
		insert into t_product
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="supplierId != null">
				supplier_id,
			</if>
			<if test="name != null">
				name,
			</if>
			<if test="num != null">
				num,
			</if>
			<if test="viewCount != null">
				view_count,
			</if>
			<if test="marketPrice != null">
				market_price,
			</if>
			<if test="memberPrice != null">
				member_price,
			</if>
			<if test="brandId != null">
				brand_id,
			</if>
			<if test="categoryId != null">
				category_id,
			</if>
			<if test="keyword != null">
				keyword,
			</if>
			<if test="title != null">
				title,
			</if>
			<if test="mainImageUrl != null">
				main_image_url,
			</if>
			<if test="imageUrlList != null">
				image_url_list,
			</if>
			<if test="state != null">
				state,
			</if>
			<if test="updateTime != null">
				update_time,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="description != null">
				description,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="supplierId != null">
				#{supplierId,jdbcType=BIGINT},
			</if>
			<if test="name != null">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="num != null">
				#{num,jdbcType=VARCHAR},
			</if>
			<if test="viewCount != null">
				#{viewCount,jdbcType=BIGINT},
			</if>
			<if test="marketPrice != null">
				#{marketPrice,jdbcType=DOUBLE},
			</if>
			<if test="memberPrice != null">
				#{memberPrice,jdbcType=DOUBLE},
			</if>
			<if test="brandId != null">
				#{brandId,jdbcType=BIGINT},
			</if>
			<if test="categoryId != null">
				#{categoryId,jdbcType=BIGINT},
			</if>
			<if test="keyword != null">
				#{keyword,jdbcType=VARCHAR},
			</if>
			<if test="title != null">
				#{title,jdbcType=VARCHAR},
			</if>
			<if test="mainImageUrl != null">
				#{mainImageUrl,jdbcType=VARCHAR},
			</if>
			<if test="imageUrlList != null">
				#{imageUrlList,jdbcType=VARCHAR},
			</if>
			<if test="state != null">
				#{state,jdbcType=VARCHAR},
			</if>
			<if test="updateTime != null">
				#{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="description != null">
				#{description,jdbcType=LONGVARCHAR},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		update t_product
		<set>
			<if test="supplierId != null">
				supplier_id = #{supplierId,jdbcType=BIGINT},
			</if>
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="num != null">
				num = #{num,jdbcType=VARCHAR},
			</if>
			<if test="viewCount != null">
				view_count = #{viewCount,jdbcType=BIGINT},
			</if>
			<if test="marketPrice != null">
				market_price = #{marketPrice,jdbcType=DOUBLE},
			</if>
			<if test="memberPrice != null">
				member_price = #{memberPrice,jdbcType=DOUBLE},
			</if>
			<if test="brandId != null">
				brand_id = #{brandId,jdbcType=BIGINT},
			</if>
			<if test="categoryId != null">
				category_id = #{categoryId,jdbcType=BIGINT},
			</if>
			<if test="keyword != null">
				keyword = #{keyword,jdbcType=VARCHAR},
			</if>
			<if test="title != null">
				title = #{title,jdbcType=VARCHAR},
			</if>
			<if test="mainImageUrl != null">
				main_image_url = #{mainImageUrl,jdbcType=VARCHAR},
			</if>
			<if test="imageUrlList != null">
				image_url_list = #{imageUrlList,jdbcType=VARCHAR},
			</if>
			<if test="state != null">
				state = #{state,jdbcType=VARCHAR},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="description != null">
				description = #{description,jdbcType=LONGVARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKeyWithBLOBs" parameterType="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		update t_product
		set supplier_id = #{supplierId,jdbcType=BIGINT},
		name =
		#{name,jdbcType=VARCHAR},
		num = #{num,jdbcType=VARCHAR},
		view_count =
		#{viewCount,jdbcType=BIGINT},
		market_price =
		#{marketPrice,jdbcType=DOUBLE},
		member_price =
		#{memberPrice,jdbcType=DOUBLE},
		brand_id = #{brandId,jdbcType=BIGINT},
		category_id = #{categoryId,jdbcType=BIGINT},
		keyword =
		#{keyword,jdbcType=VARCHAR},
		title = #{title,jdbcType=VARCHAR},
		main_image_url = #{mainImageUrl,jdbcType=VARCHAR},
		image_url_list =
		#{imageUrlList,jdbcType=VARCHAR},
		state = #{state,jdbcType=VARCHAR},
		update_time = #{updateTime,jdbcType=TIMESTAMP},
		create_time =
		#{createTime,jdbcType=TIMESTAMP},
		description =
		#{description,jdbcType=LONGVARCHAR}
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.yellowstone.entity.Product">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Fri Jul 03 
			16:03:45 CST 2015. -->
		update t_product
		set supplier_id = #{supplierId,jdbcType=BIGINT},
		name =
		#{name,jdbcType=VARCHAR},
		num = #{num,jdbcType=VARCHAR},
		view_count =
		#{viewCount,jdbcType=BIGINT},
		market_price =
		#{marketPrice,jdbcType=DOUBLE},
		member_price =
		#{memberPrice,jdbcType=DOUBLE},
		brand_id = #{brandId,jdbcType=BIGINT},
		category_id = #{categoryId,jdbcType=BIGINT},
		keyword =
		#{keyword,jdbcType=VARCHAR},
		title = #{title,jdbcType=VARCHAR},
		main_image_url = #{mainImageUrl,jdbcType=VARCHAR},
		image_url_list =
		#{imageUrlList,jdbcType=VARCHAR},
		state = #{state,jdbcType=VARCHAR},
		update_time = #{updateTime,jdbcType=TIMESTAMP},
		create_time =
		#{createTime,jdbcType=TIMESTAMP}
		where id = #{id,jdbcType=BIGINT}
	</update>


	<resultMap id="SearchResultMap" type="com.yellowstone.dto.SearchDetail">
		<result column="id" jdbcType="BIGINT" property="productId" />
		<result column="name" jdbcType="VARCHAR" property="productName" />
		<result column="main_image_url" jdbcType="VARCHAR" property="mainImageUrl" />
		<result column="image_url_list" jdbcType="VARCHAR" property="jsonImageList" />
		<result column="brand_id" jdbcType="BIGINT" property="brandId" />
		<result column="view_count" jdbcType="BIGINT" property="viewCount" />
		<result column="sales" jdbcType="BIGINT" property="sales" />
	</resultMap>


	<select id="searchAllProduct" parameterType="com.yellowstone.dto.SearchParam"
		resultMap="SearchResultMap">
		select * from (
		select
		p.id,p.name,p.main_image_url,p.image_url_list,p.brand_id,p.view_count,so.quantity
		as sales from
		t_product p
		left join
		t_product_attribute pa
		on p.id =
		pa.product_id
		left join
		( select state,product_id,sum(quantity) as
		quantity from t_sub_order
		where state = 'FINISH' group by product_id)
		so
		on
		p.id = so.product_id
		<include refid="commonSearch" />
		) tmp
		<if test="orderColumn != null and order != null">
			order by
			tmp.${orderColumn} ${order}
		</if>
		<include refid="Page.footer" />
	</select>

	<select id="count" resultType="java.lang.Integer">
		select count(1) from
		(
		select
		p.id,p.name,p.main_image_url,p.image_url_list,p.brand_id,p.view_count,so.quantity
		as sales from
		t_product p
		left join
		t_product_attribute pa
		on p.id =
		pa.product_id
		left join
		( select state,product_id,sum(quantity) as
		quantity from t_sub_order
		where state = 'FINISH' group by product_id)
		so
		on
		p.id = so.product_id
		<include refid="commonSearch" />
		) tmp
	</select>

	<sql id="commonSearch">
		where 1 = 1
		<if test="keyWord != null">
			and
			(p.name like CONCAT(CONCAT('%',
			#{keyWord,jdbcType=VARCHAR},'%')) or
			p.keyword like CONCAT(CONCAT('%',
			#{keyWord,jdbcType=VARCHAR},'%')))
		</if>
		<if test="categoryIds != null">
			and
			p.category_id in
			<foreach close=")" collection="categoryIds" index="index"
				item="item" open="(" separator=",">
				#{item}
			</foreach>
		</if>
		<if test="brandId != null">
			and
			p.brand_id = #{brandId,jdbcType=BIGINT}
		</if>
		<if test="attributeIds != null">
			and pa.attribute_id in
			<foreach close=")" collection="attributeIds" index="index"
				item="item" open="(" separator=",">
				#{item}
			</foreach>
		</if>
		and
		p.state = 'approved'
		group by p.id
	</sql>
	<select id="selectDetailByPrimaryKey"
		parameterType="site.wmblog.mapper.query.product.ProductDetailQuery"
		resultType="com.yellowstone.dto.product.ProductDetail">
		select tp.id,tp.view_count as viewCount,tb.name as
		brandname,tp.name,tp.title,tp.num,tp.description
		,tp.main_image_url as
		mainimageurl,tp.image_url_list as imageurllist,
		tc3.name as
		categoryname3,tc2.name as categoryname2,tc1.name as categoryname1,
		tc3.id as categoryid3,tc2.id as categoryid2,tc1.id as categoryid1
		from
		t_product tp left join t_brand tb on tp.brand_id=tb.id
		left join
		t_category tc3 on tp.category_id = tc3.id
		left join t_category tc2 on
		tc3.parent_id=tc2.id
		left join t_category tc1 on tc2.parent_id=tc1.id
		<where>
			tp.id =#{productId}
		<!--	<if test="state == null or state == '' ">
				and tp.state = 'approved'
			</if>-->
			<if test="state != null and state != ''">
				and tp.state = #{state}
			</if>
		</where>


	</select>

	<select id="selectSimpleByPrimaryKey" parameterType="java.lang.Long"
		resultType="com.yellowstone.dto.product.ProductSimple">
		select id,name,main_image_url as mainImageUrl,title from
		t_product where id =
		#{id} and state = 'approved'
	</select>
	<select id="selectByPage" parameterType="site.wmblog.mapper.query.product.ProductQuery"
		resultMap="ProductDtoMap">
		<include refid="Page.header" />
		select id,name,num,market_price,state,create_time from t_product
		<where>
			<if test="supplierId != null">
				supplier_id = #{supplierId}
			</if>
			<if test="name != null and name != ''">
				and name like '%${name}%'
			</if>
			<if test="num != null and num != ''">
				and num like '%${num}%'
			</if>
			<if test="startTime != null">
                <![CDATA[
				and create_time >= #{startTime}
				 ]]>
			</if>
			<if test="endTime != null">
                <![CDATA[
				and create_time <= #{endTime}
				]]>
			</if>
		</where>

		order by
		<if test="sort.property != null and sort.property != ''">
			${sort.property} ${sort.direction},
		</if>
		id desc
		<include refid="Page.footer" />
	</select>
	<select id="countByPage" parameterType="site.wmblog.mapper.query.product.ProductQuery"
		resultType="int">
		select count(*) from t_product
		<where>
			<if test="supplierId != null">
				supplier_id =#{supplierId}
			</if>
			<if test="name != null and name != ''">
				and name like '%${name}%'
			</if>
			<if test="num != null and num != ''">
				and num like '%${num}%'
			</if>
			<if test="startTime != null and startTime != ''">
                <![CDATA[
				and create_time >= #{startTime}
				 ]]>
			</if>
			<if test="endTime != null and endTime != ''">
                <![CDATA[
				and create_time <= #{endTime}
				]]>
			</if>

		</where>
	</select>
	<select id="selectByCategoryId" parameterType="java.lang.Long"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_product
		where category_id = #{categoryId}
	</select>
</mapper>
